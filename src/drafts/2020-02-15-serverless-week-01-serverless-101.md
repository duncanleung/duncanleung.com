---
date: 2020-02-15
title: Serverless Notes
template: post
thumbnail: "../thumbnails/serverless.png"
slug: serverless-notes
categories:
  - Serverless
tags:
  - serverless
  - aws-lambda
  - aws-api-gateway
  - aws-iam
---

<!-- ------------------------------------------------------------------------------------------------------- -->

## Create Serverless

```terminal
sls create -t aws-nodejs
```

<!-- ------------------------------------------------------------------------------------------------------- -->

# Managing Permissions for Serverless Framework

AWS profile was configured with an IAM user with full admin access

principle of least privilege and start with the bare minimum of permissions, such as S3 create bucket, and gradually add more permissions as the developers bump against the wall when they try to deploy

- Add additional deploy or when you remove an existing deployment
- creating and deleting S3 buckets and creating CloudFormation stacks, etc

starting with a dedicated deployed user with admin access in your development account

- Developers can freely develop and experiment
- only copy over the permissions they have actually used to the deployer role in the production account
- less friction in the process, but it's predicated on the assumption that you have account-level separation between environments, so that those admin assets are never handed out for the production account
- see what services were accessed by, and I'll stress this, the dedicated deployer user
  (screenshot in Production Ready Serverless: 1. Intro > Managing persmissions)

---

<!-- ------------------------------------------------------------------------------------------------------- -->

# Week 01

## Serverless 101:

### Timeout

- API Gateway has a hard limit timeout of 29 seconds
- Serverless framework has a default function timeout of 6 seconds

## Commands

```terminal
$ sls package
```

### Running locally

```javascript
"use strict";

module.exports.hello = async (event) => {
  return {
    statusCode: 200,
    body: JSON.stringify(
      {
        message: `FOO: ${process.env.FOO}`,
        input: event,
      },
      null,
      2
    ),
  };
};
```

```terminal
$ sls invoke local -f hello -d '{"bar": "foo"}'

{
    "statusCode": 200,
    "body": "{\n  \"message\": \"FOO: BAR\",\n  \"input\": {\n    \"bar\": \"foo\"\n  }\n}"
}
```

### Attach debugger

Install serverless as a local dependency to project

```terminal
$ yarn add -D serverless
```

<div class="filename">launch.json</div>

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "type": "node",
      "request": "launch",
      "name": "Launch Program",
      "program": "${workspaceFolder}/node_modules/.bin/sls",
      "args": ["invoke", "local", "-f", "hello", "-p", "package.json"]
    }
  ]
}
```

- Debugger
- Set breakpoint in VSCode
- Run

Useful when you have a set up to write the event payload into your log

- Can run the function locally with the debugger attached

### Invoke remotely

The same function name as in `serverless.yml`

```yml{10}
service: serverless-workshop

provider:
  name: aws
  runtime: nodejs12.x
  environment:
    STAGE: dev

functions:
  hello:
    handler: handler.hello
    environment:
      FOO: BAR
    events:
      - http:
          path: /
          method: get
```

pass in data

```terminal
$ serverless invoke -f hello -d '{"foo": "bar"}'
```

### View most recent logs

```terminal
$ serverless logs -f hello
```

### Deploy

Deploys using cloudformation

There are two `cloudformation-template...json`

`cloudformation-template-create-stack.json`
Creates the S3 bucket - uploads the packed up artifacts generated by Serverless framework

`cloudformation-template-update-stack.json`
Updates CloudFormation stack and provisions the functions

```terminal
$ serverless deploy
```

Deploy just one function
Use lambda API to update function code instead of CloudFormation

```terminal
$ serverless deploy -f hello
```

Deploy to specific sage or region

```yml{6,7}
service: serverless-workshop

provider:
  name: aws
  runtime: nodejs12.x
  stage: dev
  region: us-east-1

functions:
  hello:
    handler: handler.hello
    events:
      - http:
          path: /
          method: get
```

`-s`: stage
`-r`: region

```terminal
$ serverless deploy -s staging -r eu-west-1
```

### Remove

```terminal
$ serverless remove -s staging -r eu-west-1
```
